# Introduction

The following document describes a step-by-step description of the Raspberry Pi setup for Snap7 Express Server.

Target audience of thisdocument are developers configuring the hardware to be built into a buidl√∂ing for connecting the gates with the Parcandi platform

Configuration should be conducted before the hardware is built into the building

# Raspberry Pi Setup

## Setup raspbian

Get the official [Raspbian release](https://www.raspberrypi.org/downloads/raspbian/) manually or use the Raspberry PI Imager https://www.raspberrypi.org/downloads/ which will help you write the OS files to the SD Card.

1. Choose Raspberry PI OS Lite (32-Bit)
2. Choose SD Card you have inserted
3. Write

**Hint: Headless installation**

Place the following files in /boot of the SD card

* empty file ```ssh``` to use ssh
* ```wpa_supplicant.conf``` to setup your wifi
```
country=US # Your 2-digit country code
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
network={
    ssid="YOUR_NETWORK_NAME"
    psk="YOUR_PASSWORD"
    key_mgmt=WPA-PSK
}
```

## Raspberry Pi with additional ethernet hat

Append to ```/boot/config.txt```

```
dtoverlay=enc28j60
```

at the end of the file to enable the Pi zero Enc28j60 Network Adapter Module. This hardware module is used to provide a secondary ethernet port.

## Raspberry Pi with 3g/4g/LTE hat

tbd.


## Install Node

Don't use the official Raspbian node version. Instead install node manually.

Get the link of the most recent version from
```
https://nodejs.org/en/download/
```

Get the installer for ARMv7 (Raspberry Pi I is not supported).
```
$ wget https://nodejs.org/dist/v12.18.3/node-v12.18.3-linux-armv7l.tar.xz
```

Extract the file. Please make sure to change the filename.
```
$ tar -xzf node-v12.18.3-linux-armv7l.tar.gz
```

Change to the archive folder and cop Node to /usr/local
```
$ cd node-v12.16.1-linux-armv7l
$ sudo cp -R * /usr/local
```

## Installing PM2

To deamonize the gateway application we us PM2. This allows us to start the gateway application in the background as a service.

```
$ sudo npm install pm2@latest -g
```
This will install pm2 globally.

## Install git
```
$ sudo apt update
$ sudo apt install git
```

## Install Snap7 Express Server

Install the node.js express REST server in ```/var```

```
$ sudo mkdir /var/node
$ sudo chown pi.pi /var/node
$ cd /var/node
$ git clone https://github.com/bet-smart-parking/snap7-express-server.git
$ cd snap7-express-server
$ npm install
```

Then configure ```.env``` File according to your system. ```PLC_IP``` is the address of the LOGO!8 box.

## Run Snap7 Express Server as Service

Run the server through PM2
```
$ pm2 start index.js
```

Run PM2 on system startup
```
$ pm2 startup systemd
```
Copy the last line of the output and run it with superuser priviledges
```
$ sudo env PATH=$PATH:/usr/local/bin /usr/local/lib/node_modules/pm2/bin/pm2 startup systemd -u pi --hp /home/pi
```


## SSL Certificates

The SSL certifiactes will be used to secure the connection to the gateway application.

Note: This step requires a FQDN.
Note: Make sure that the raspberry pi is reachable on the internet on port 80.

A SSL certificate to protect the communication of the gateway is generated by use of letsentcrypt.

```
$ sudo apt-get install letsencrypt
$ sudo certbot certonly  -d <DOMAINNAME> -m <YOUREMAIL@EXAMPLE.COM>
```

Make sure to replace ```<DOMAINNAME>``` by your FQDN and ```<YOUREMAIL@EXAMPLE.COM>``` by your email. The script will ask you how to verify your FQDN, select ```Spin up a temporary webserver (standalone)``` if you aren't running another webserver.

As the certificates will expire after 3 months, you should add a crontab entry executing the job regularily.

```
$ sudo crontab -e
```

Insert  ```0 1 * * 1 /usr/bin/certbot renew``` at the end of the file. This will trigger the renewal of all ceritficates once every week.

The certifiacte is stored at ```/etc/letsencrypt/live/<FQDN>/cert.pem``` and the corresponding key is stored at ```/etc/letsencrypt/live/<FQDN>/privkey.pem```. Make sure to keep the key file private.

## Nginx as reverse proxy

Nginx will be used as reverse proxy to the snap7 express gateway.

```
$ sudo apt-get install nginx
```

To protect the API with basic auth, create the file ```/etc/nginx/conf.d/htpasswd```:

```
$ sudo apt-get install apache2-utils
$ sudo htpasswd -c /etc/nginx/conf.d/htpasswd <USERNAME>
```

Replace ```<USERNAME>``` by the username you want to use. Choose a password for the user.

Replace the content of ```/etc/nginx/sites-enabled/default``` with

```
server {
        listen 443 ssl default_server;
        listen [::]:443 ssl default_server;
        ssl_certificate /etc/letsencrypt/live/<FQDN>/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/<FQDN>/privkey.pem;

        root /var/www/html;

        server_name _;

        error_page 401 /smartparking_401.html;
        location = /smartparking_401.html {
                root /var/node/snap7-express-server/errorpages/;
                internal;
        }

        error_page 403 /smartparking_403.html;
        location = /smartparking_403.html {
                root /var/node/snap7-express-server/errorpages/;
                internal;
        }

        error_page 404 /smartparking_404.html;
        location = /smartparking_404.html {
                root /var/node/snap7-express-server/errorpages/;
                internal;
        }

        error_page 502 /smartparking_502.html;
        location = /smartparking_502.html {
                root /var/node/snap7-express-server/errorpages/;
                internal;
        }

        location /api/opengate/ {
                rewrite            /api/(.*)/(.*) /$1?gateId=$2 break;
                proxy_redirect     off;
                proxy_set_header   Host $http_host;
                proxy_pass         http://127.0.0.1:3000;
                # comment the next 2 lines if you want to skip basic auth
                auth_basic              "Private API";
                auth_basic_user_file    conf.d/htpasswd;
        }

        location /api/docs/ {
                rewrite            /api/(.*) /$1 break;
                proxy_redirect     off;
                proxy_set_header   Host $http_host;
                proxy_pass         http://127.0.0.1:3000;
        }
}
```

The first server section will do reverse proxying to the Snap7 Express Server. The second section will redirect all http requests through https.

Make sure to replace ```<FQDN>``` with the full qualified domain name of your gateway or, if you have choosen a different location, with the path to your certificates.

### Check config with restart

Check with a restart if the server is still running.

```
$ sudo /etc/init.d/nginx restart
```

## Ethernet setup

Set the IP addresses of the ethernet port(s) in ```/etc/dhcpcd.conf```:
```
# static IP address of the internet connection (wired setup through router)
interface eth0
static ip_address=<static ip>
static routers=<router ip>
static domain_name_servers=<dns name server>

# (Optional - only if static IP address for internet connection required)
interface eth1
static ip_address=192.168.0.1
static routers=192.168.0.1
```

The eth0 IP address must be configured to an address within the same network of the LOGO!8 and different from the address of LOGO!8.

Optionally eth1 must be configured to the static IP address provided by the internet service provider. Note that this only applies to installations with a wired internet connection (see [hardware installation manual](./hardware_installation.md "hardware installation manual")) and with a static IP.

For wired connections w/o static IP address, dhcp will determine the network configuration. Make sure to setup port forwarding within your router to forward port 443 to Raspberry Pis ethernet address.
